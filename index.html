<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<title>Book Finder</title>

<link rel="stylesheet" href="style.css">
</head>

<body>

<header>üìö Book Finder</header>

<section class="search-box">
  <input id="titolo" placeholder="Titolo">
  <input id="autore" placeholder="Autore">
  <input id="anno" placeholder="Anno">
  <div class="autocomplete-container">
    <input id="soggetto" placeholder="genere">
    <div id="dropdownGeneri" class="autocomplete-dropdown"></div>
  </div>
  <button id="cercaBtn">Cerca</button>
</section>

<div id="loader" class="loader"></div>
<section id="risultati"></section>

<section id="risultati"></section>

<div class="pagination">
  <button id="prev">‚¨Ö Precedente</button>
  <button id="next">Successiva ‚û°</button>
</div>

<script type="module">
import { Libro, cercaLibro, generaURL, getNumLibri, cercaLibriTrend } from './richiesteAPI.js';

let pagina = 0;
let pagMax = 0;
let numLibri = 0;
const limite = 12;
let URLvecchio = "";
let filtri = {}

const risultatiContainer = document.getElementById("risultati");
const loader = document.getElementById("loader");


async function cerca(){
  risultatiContainer.innerHTML="";
  loader.style.display = "block";
  try{
    const URL = generaURL(filtri, limite, pagina);
    const risLibri = await cercaLibro(URL);
    loader.style.display = "none";
    mostraLibri(risLibri);
  }catch(e){
    loader.style.display = "none";
    risultatiContainer.innerHTML = `<div class="errore-api">‚ö†Ô∏è Errore nel caricamento dei dati. Riprova.</div>`;
    console.error(e);
  }
}

function mostraLibri(lista){
  risultatiContainer.innerHTML="";

  if(lista.length===0){
    risultatiContainer.innerHTML="<h2>Nessun risultato</h2>";
    return;
  }

  lista.forEach(libro=>{
    const card = document.createElement("div");
    card.className="card";

    card.onclick = () => {
      const params = new URLSearchParams({
        id: libro.id,
        titolo: libro.titolo,
        autore: libro.autori,
        isbn: libro.isbn || ""
      });

      sessionStorage.setItem("libroSelezionato",
        JSON.stringify({
          key: libro.id,
          title: libro.titolo,
          author_name: libro.autori.split(", "),
          isbn: libro.isbn ? [libro.isbn] : [],
          first_publish_year: libro.anno,
          cover_i: libro.coverId,
          subject: libro.soggetti
        })
      );

      window.location.href = "dettagli.html";
    };

    card.innerHTML=`
      <img src="${libro.getCoverUrl('M')}">
      <h3>${libro.titolo}</h3>
      <p><b>Autore:</b> ${libro.autori}</p>
      <p><b>Anno:</b> ${libro.anno}</p>
      <p><b>ISBN:</b> ${libro.isbn ?? "N/A"}</p>
    `;

    risultatiContainer.appendChild(card);
  });
}

async function generaTrend(){
  risultatiContainer.innerHTML="";

  loader.style.display = "block";
  try{
    const libriTrend = await cercaLibriTrend("weekly");
    loader.style.display = "none";
    mostraLibri(libriTrend);
  }catch(e){
    loader.style.display = "none";
    risultatiContainer.innerHTML = `<div class="errore-api">‚ö†Ô∏è Errore nel caricamento dei dati. Riprova.</div>`;
    console.error(e);
  }
}

cercaBtn.onclick=()=>{
  filtri = {
    titolo: titolo.value,
    autore: autore.value,
    anno: anno.value,
    soggetto: soggetto.value
  };
  pagina=1;
  const URL = generaURL(filtri, limite, pagina);
  numLibri = getNumLibri(URL);
  pagMax = Math.ceil(numLibri / limite);
  cerca();
};

prev.onclick=()=>{
  if(pagina>1){
    pagina--;
    cerca();
  }
};

next.onclick=()=>{
  if(pagina != pagMax){
    pagina++;
    cerca();
  }
  
};

generaTrend();
</script>

</body>
</html>